services:
  web:
    build:
      context: .
    container_name: uni-api-frontend
    restart: unless-stopped
    depends_on:
      - api
    environment:
      API_BASE_URL: http://api:8000/v1
      NEXT_TELEMETRY_DISABLED: 1
      NODE_ENV: production
      APP_NAME: ${APP_NAME:-MyApp}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI:-}
    ports:
      - "3000:3000"

  db:
    image: postgres:17.6-alpine
    container_name: uni-api-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-uniapi}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      POSTGRES_DB: ${POSTGRES_DB:-uniapi}
    ports:
      - "5432:5432"
    volumes:
      - uniapi_pg_data:/var/lib/postgresql/data

  api:
    build:
      context: ./apps/api
    container_name: uni-api-backend
    restart: unless-stopped
    depends_on:
      - db
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-uniapi}:${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}@db:5432/${POSTGRES_DB:-uniapi}
      APP_ENV: dev
      APP_NAME: Uni API Backend
      API_PREFIX: /v1
      SESSION_TTL_DAYS: 7
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI:-}
      ADMIN_BOOTSTRAP_TOKEN: ${ADMIN_BOOTSTRAP_TOKEN:-}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      RESEND_FROM_EMAIL: ${RESEND_FROM_EMAIL:-Uni API <onboarding@resend.dev>}
      EMAIL_VERIFICATION_REQUIRED: ${EMAIL_VERIFICATION_REQUIRED:-true}
    ports:
      - "8001:8000"

volumes:
  uniapi_pg_data:
